---
format:
  html:
    code-fold: true
---

# EDA

Este capítulo lleva a cabo un **Exploratory Data Analysis** (análisis exploratorio de datos) para ir sacando información, conclusiones o inferencias a partir de los [datos escrapeados](scrap.qmd).

## Librerías utilizadas

```{r}
#| warning: false
#| code-fold: false
library(tidyverse)
library(kableExtra)
library(ggridges)
library(scales)
library(ggdist)
library(mapSpain)
library(sf)
library(ggrepel)
```

## Datos de partida

### Temporadas

```{r message=FALSE}
(df_temporadas <- read_csv("data/temporadas.csv") |>
  mutate(
    edicion = as.factor(edicion),
    duracion = as.difftime(duracion, units = "days"),
    cadena = fct_inorder(cadena)
  )
) |> kable()
```

### Concursantes

```{r message=FALSE}
(df_concursantes <- read_csv("data/concursantes.csv") |>
  mutate(
    genero = factor(genero, levels = c("H", "M")),
    edicion = as.factor(edicion),
    comunidad = as.factor(comunidad)
  )
) |> slice_head(n = 10) |> kable()
```

### Galas

```{r message=FALSE}
(df_galas <- read_csv("data/galas.csv") |>
  mutate(
    edicion = as.factor(edicion),
    estado = as.factor(estado) 
  )
) |> slice_head(n = 10) |> kable()
```

## Análisis exploratorio

### Distribución de edad por edición

En el siguiente gráfico se muestra la distribución de edad de los concursantes en cada edición del programa.

Desde luego la gran mayoría se encuentran en el rango de 20 a 25 años. Resulta curiosa la distribución de OT2011 con dos núcleos diferenciados de edad. Igualmente OT2008 y OT2017 muestran ciertos "flecos" de edades algo mayores.

```{r}
#| message: false
#| warning: false
df_concursantes |>
  left_join(df_temporadas) |>
  ggplot(aes(x = edad, y = edicion, fill = cadena)) +
    geom_density_ridges() +
    coord_cartesian(clip = "off") +
    theme_minimal() +
    scale_x_continuous(
      breaks = breaks_width(5),
      minor_breaks = breaks_width(1),
      labels = \(x) paste(x, "años")
    ) +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    ) +
    theme(
      panel.grid.major.y = element_blank()
    )
```

### Duración del programa por edición

En el siguiente gráfico se muestra la duración de cada edición en días, teniendo en cuenta la fecha de comienzo y de finalización.

Obviamente OT2020 se tuvo que alargar hasta los 150 días (unos 5 meses) debido a la pandemia. Por el lado contrario resulta llamativo que OT2011 haya durado tan poco (en torno a 1 mes), quizás por cuestiones de audiencia.

```{r}
#| message: false
#| warning: false
df_temporadas |>
  ggplot(aes(x = edicion, y = duracion, color = cadena)) +
    geom_line(group = 1, size = 1) +
    geom_point(size = 3) +
    scale_y_continuous(
          labels = \(y) paste(y, "días")
        ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      color = NULL,
    ) +
    theme(
      axis.text.x = element_text(angle = -45, hjust = 0)
    )
```
### Distribución de género por edición 

En el siguiente gráfico se muestra una especie de "pirámide poblacional" con la proporción (en porcentaje) de hombres y mujeres en cada edición del programa.

Por lo general todas las ediciones han sido bastante equilibradas en cuanto a la distribución de género exceptuando OT2001 donde el número de hombres era muy superior al de mujeres.

```{r}
#| message: false
#| warning: false
df_concursantes |>
  left_join(df_temporadas) |>
  count(edicion, genero) |>
  group_by(edicion) |>
  mutate(
    porcentaje = n / sum(n) * 100,
    valor = if_else(genero == "H", -porcentaje, porcentaje)
  ) |>
  mutate(
    genero = case_match(
      genero,
      "H" ~ "Hombre",
      "M" ~ "Mujer"
    ) 
  ) |>
  ggplot(aes (x = valor, y = edicion, fill = genero)) +
    geom_col(width = 0.8) +
    geom_vline(xintercept = 0, color = "grey40") +
    scale_x_continuous(
      labels = function(x) paste0(abs(x), "%"),
      breaks = breaks_width(20),
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    )
```
### Tiempo hasta la siguiente edición

En el siguiente gráfico se muestra el tiempo transcurrido (en años) entre el final de una edición del programa y el comienzo de otra.

Por encima de todo destacan los casi 7 años de espera tras OT2011 en el que el programa volvió a "La 1".

```{r}
#| warning: false
df_temporadas |>
  mutate(
    hasta_siguiente = (estreno - lag(final)) / 365.25,
    etiqueta_intervalo = paste(lag(edicion), "hasta", edicion)
  ) |>
  drop_na("hasta_siguiente") |>
  ggplot(aes(y = hasta_siguiente, x = etiqueta_intervalo, color = cadena)) +
    geom_line(group = 1, size = 1) +
    geom_point(size = 3) +
    scale_y_continuous(
      labels = \(x) paste(x, "años"),
      breaks = breaks_width(1),
      limits = c(0, NA)
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      color = NULL,
    ) +
    theme(
      axis.text.x = element_text(angle = -45, hjust = 0)
    )
```

### Audiencias por edición

En el siguiente gráfico se muestra la audiencia (número de espectadores en millones) de cada edición del programa.

Los 7 millones de espectadores de OT2001 es un hito en la historia de la televisión. Resulta llamativo que las audiencias van descendiendo hasta que llega un cambio de canal, donde vuelven a repuntar pero siguen con la tendencia a la baja. No hay datos de OT2025.

```{r}
#| warning: false
df_temporadas |>
  ggplot(aes(x = edicion, y = audiencia, color = cadena)) +
    geom_line(group = 1, size = 1) +
    geom_point(size = 3) +
    scale_y_continuous(
      labels = label_number(scale = 1e-6, suffix = "M"),
      breaks = breaks_width(1e6)
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      color = NULL,
    ) +
    theme(
      axis.text.x = element_text(angle = -45, hjust = 0)
    )
```
### Edad media de cada edición

En el siguiente gráfico se muestra la edad media de los concursantes de cada edición del programa.

Todas las ediciones de "La 1" y "Prime Video" tienen una edad media muy similar (entre 21 y 22 años) sin embargo las ediciones emitidas en Telecinco tienen edades medias más dispares.

El gráfico se ha recortado a partir de 18 años donde se encuentra la zona de interés.

```{r}
#| message: false
#| warning: false
df_concursantes |>
  left_join(df_temporadas) |>
  group_by(edicion) |>
  summarise(
    edicion = first(edicion),
    cadena = first(cadena),
    edad = mean(edad)
  ) |>
  ggplot(aes(x = edicion, y = edad, color = cadena)) +
    geom_line(group = 1, size = 1) +
    geom_point(size = 3) +
    scale_y_continuous(
      labels = \(x) paste(x, "años"),
      breaks = breaks_width(1)
    ) +
    coord_cartesian(ylim = c(18, NA)) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      color = NULL,
    ) +
    theme(
      axis.text.x = element_text(angle = -45, hjust = 0)
    )
```
### Distribución de concursantes por CCAA

En el siguiente gráfico se muestra la proporción (en porcentaje) de todos los concursantes en la historia de OT agrupados por su Comunidad Autónoma.

Andalucía es, de largo, la Comunidad Autónoma que más concursantes ha aportado al programa. Como detalle, no ha habido ningún concursante de La Rioja en la historia de OT.

```{r}
ccaa <- esp_get_ccaa() |> select(n = ccaa.shortname.es) |> st_drop_geometry() |> pull(n)

df_concursantes |>
  count(comunidad) |>
  complete(comunidad = ccaa, fill = list(n = 0)) |>
  mutate(
    porcentaje = n / sum(n) * 100
  ) |>
  ggplot(aes(x = porcentaje, y = fct_reorder(comunidad, porcentaje))) +
    geom_segment(aes(x = 0, xend = porcentaje, yend = comunidad), size = 1, color = "#619CFF") +
    geom_point(size = 3, color = "#619CFF") +
    scale_x_continuous(
      labels = \(x) paste0(x, "%"),
      breaks = breaks_width(5)
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      color = NULL,
    ) +
    theme(
      panel.grid.major.y = element_blank()
    )
```
### Número (distinto) de CCAA en cada edición

En el siguiente gráfico se muestra el número de Comunidades Autónomas de los concursantes en las distintas ediciones del programa.

Cabe destacar la "poca" variedad de OT2008 con sólo 5 Comunidades Autónomas representando concursantes. Por lo general todas las ediciones son bastante diversas en este sentido.

```{r}
#| message: false
df_concursantes |>
  left_join(df_temporadas) |>
  group_by(edicion) |>
  summarise(
    n_comunidades = n_distinct(comunidad),
    cadena = first(cadena)
  ) |>
  ggplot(aes(x = edicion, y = n_comunidades, color = cadena)) +
    geom_line(group = 1, size = 1) +
    geom_point(size = 3) +
    scale_y_continuous(
      breaks = breaks_width(1)
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      color = NULL,
    ) +
    theme(
      axis.text.x = element_text(angle = -45, hjust = 0)
    )
```

### Distribución de edad por género

En el siguiente gráfico se muestra la distribución de edad de los concursantes del programa en función de su género.

En su mediana, podríamos decir que los hombres concursantes son 1 año mayores que las mujeres concursantes. Ellos están en una mediana de 22 años y ellas en 21 años. Igualmente viendo la curva se observa que la distribución de edad de los hombres es más "normal" (en el concepto estadístico) mientras que la de las mujeres tiene una cierta asimetría negativa (mayor cantidad de edades jóvenes).

```{r}
#| message: false
#| warning: false
df_concursantes |>
  ggplot(aes(x = genero, y = edad)) +
    stat_halfeye(
      aes(fill = genero),
      adjust = .7,
      width = .5,
    ) +
    geom_dots(
      aes(fill = genero),
      color = NA,
      layout = "weave",
      side = "bottom",
      dotsize = 0.35,
      alpha = .3,
    ) +
    scale_x_discrete(
      labels = c(H = "Hombre", M = "Mujer"),
    ) +
    scale_y_continuous(
      minor_breaks = breaks_width(1),
      labels = \(x) paste(x, "años")
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    ) +
    theme(
      panel.grid.major.x = element_blank(),
      legend.position = "none"
    )
```
### Primeros puestos por edición y CCAA

En el siguiente gráfico se muestran los 5 primeros concursantes clasificados en cada edición del programa identificando su Comunidad Autónoma.

```{r}
df_concursantes |>
  filter(posicion <= 5) |>
  ggplot(aes(x = posicion, y = edicion, label = concursante, fill = comunidad)) +
    geom_label(size=2.5) +
    scale_x_continuous(
      labels = \(x) paste0(x, "º"),
      expand = expansion(mult = c(0.12, 0.12))
    ) +
    coord_cartesian(clip = "off") +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    ) +
    theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.major.x = element_blank(),
      legend.position = "bottom",
    )
```
### Primer puesto por Comunidad Autónoma

En el siguiente gráfico se muestra el número de concursantes ganadores en cada Comunidad Autónoma.

Destaca especialmente Andalucía con 4 ganadores en la historia del programa.

```{r}
df_concursantes |>
  filter(posicion <= 1) |>
  count(comunidad, name = "ganadores") |>
  right_join(
    esp_get_ccaa(),
    by = c("comunidad" = "ccaa.shortname.es"),
  ) |>
  select(
    comunidad, ganadores, geometry
  ) |>
  replace_na(list(ganadores = 0)) |>
  ggplot(aes(geometry = geometry, fill = factor(ganadores))) +
    geom_sf() +
    coord_sf(expand = FALSE) +
    scale_fill_hue(
      labels = \(x) ifelse(x == 1, paste(x, "ganador"), paste(x, "ganadores"))
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    ) +
    theme(
      panel.grid = element_blank(),
      axis.text = element_blank()
    )
```
### Distribución de concursantes favoritos

En el siguiente gráfico se muestra el porcentaje de "favorito/a" en las distintas ediciones del programa.

Destaca claramente Rosa López (OT2001) con casi un 70% como favorita. Otro patrón que se infiere es que cuanto más avanzan las ediciones mayor es el número de concursantes favoritos.

```{r}
#| fig-height: 10 
#| fig-width: 10
df_galas |>
  group_by(edicion) |>
  mutate(total_galas = max(gala)) |>
  group_by(edicion, concursante) |>
  summarise(
    favs = sum(estado == "FAV"),
    total_galas = first(total_galas),
    .groups = "drop"
  ) |>
  mutate(porcentaje_fav = favs / total_galas * 100) |>
  filter(porcentaje_fav > 0) |>
  ggplot(aes(x = str_trunc(concursante, 20), y = porcentaje_fav, fill = edicion)) +
    geom_col() +
    facet_wrap(~ edicion, scales = "free_x") +
    scale_x_discrete(expand = expansion(c(0, 0.3))) +
    scale_y_continuous(
      labels = \(x) paste0(x, "%")
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    ) +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(angle = -45, hjust = 0, size = 8),
      legend.position = "none"
    )
```
### Distribución de concursantes nominados

En el siguiente gráfico se muestra el porcentaje de "nominado/a" en las distintas ediciones del programa.

Destaca claramente Nuria Elosegui (OT2003) con más de un 70% como nominada. El número de concursantes (distintos) nominados por edición es bastante alto. *La suma en cada edición no es el 100% ya que hay varios nominados/as por gala*.

```{r}
#| fig-height: 10 
#| fig-width: 10
df_galas |>
  group_by(edicion) |>
  mutate(total_galas = max(gala)) |>
  group_by(edicion, concursante) |>
  summarise(
    noms = sum(estado == "NOM"),
    total_galas = first(total_galas),
    .groups = "drop"
  ) |>
  mutate(porcentaje_nom = noms / total_galas * 100) |>
  filter(porcentaje_nom > 0) |>
  ggplot(aes(x = str_trunc(concursante, 20), y = porcentaje_nom, fill = edicion)) +
    geom_col() +
    facet_wrap(~ edicion, scales = "free_x") +
    scale_x_discrete(expand = expansion(c(0, 0.3))) +
    scale_y_continuous(
      labels = \(x) paste0(x, "%")
    ) +
    theme_minimal() +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL,
    ) +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(angle = -45, hjust = 0, size = 8),
      legend.position = "none"
    )
```

### Número de nominaciones por concursante ganador

En el siguiente gráfico se muestra el número de nominaciones que recibió el concursante ganador en cada edición del programa.

Hay concursantes con 4 nominaciones que consiguieron ganar el concurso, mientras que otros nunca fueron nominados.

```{r}
#| message: false
#| warning: false
df_galas |>
  filter(estado == "NOM") |>
  right_join(df_concursantes) |>
  filter(posicion == 1) |>
  group_by(edicion, concursante) |>
  summarise(
    num_nominaciones = sum(estado == "NOM")
  ) |>
  replace_na(list(num_nominaciones = 0)) |> 
  ggplot(aes(x = edicion, y = num_nominaciones, label = concursante, color = factor(num_nominaciones))) +
    geom_point(size = 3) +
    geom_segment(aes(x = edicion, xend = edicion, y = 0, yend = num_nominaciones), size = 1) +
    geom_label_repel(size = 3, label.size = .5) +
    scale_color_discrete(
      labels = \(x) ifelse(x == 1, "1 nominación", paste(x, "nominaciones"))
    ) +
    labs(
      x = NULL,
      y = NULL,
      color = NULL
    ) +
    theme_minimal() +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.position = "bottom"
    )
```
### Perfil del concursante nominado

En el siguiente gráfico se muestra la distribución de edad y género de aquellos concursantes con menor y mayor número de nominaciones en cada edición.

- Aquellos concursantes con el mínimo número de nominaciones por edición son, en su mayoría, hombres de alrededor de 24 años o bien mujeres de alrededor de 19 años o ya de 26 años.
- Aquellos concursantes con el máximo número de nominaciones por edición son, en su mayoría, también hombres de alrededor de 23-24 años o bien mujeres de 19 años o ya de 25 años.

```{r}
#| message: false
#| warning: false
df_galas |>
  filter(estado == "NOM") |>
  right_join(df_concursantes) |>
  group_by(edicion, concursante) |>
  summarise(
    num_nominaciones = sum(estado == "NOM")
  ) |>
  replace_na(list(num_nominaciones = 0)) |>
  group_by(edicion) |>
  mutate(
    estado_nom = factor(case_when(
      num_nominaciones == min(num_nominaciones) ~ "MIN",
      num_nominaciones == max(num_nominaciones) ~ "MAX",
      TRUE ~ NA
    ), levels = c("MIN", "MAX"))
  ) |>
  filter(!is.na(estado_nom)) |>
  ungroup() |>
  left_join(df_concursantes) |>
  ggplot(aes(x = estado_nom, y = edad, fill = genero)) +
    stat_halfeye(
      data = \(d) d |> filter(genero == "H"),
      side = "left",
      show_interval = FALSE,
      show_point = FALSE,
      adjust = 0.7,
      width = 0.5
    ) +
    stat_halfeye(
      data = \(d) d |> filter(genero == "M"),
      side = "right",
      show_interval = FALSE,
      show_point = FALSE,
      adjust = 0.7,
      width = 0.5
    ) +
    scale_fill_discrete(
      labels = c(H = "Hombre", M = "Mujer")
    ) +
    scale_x_discrete(
      labels = c(MIN = "Mínimo número de nominaciones", MAX = "Máximo número de nominaciones")
    ) +
    scale_y_continuous(
      minor_breaks = breaks_width(1),
      labels = \(x) paste(x, "años")
    ) +
    labs(
      x = NULL,
      y = NULL,
      fill = NULL
    ) +
    theme_minimal()
```

